name: Deploy to ECR and EC2 (Prod)

on:
  push:
    branches: ["main"]

concurrency:
  group: deploy-prod
  cancel-in-progress: true

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: false
          docker-images: false
          swap-storage: true

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:prod-latest
          # ECR Registry Cache: GHA 캐시보다 빠르고 용량 제한 없음
          cache-from: type=registry,ref=${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:cache
          cache-to: type=registry,ref=${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:cache,mode=max

  deploy-to-ec2:
    needs: build-and-push
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment: production

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Deploy to EC2 via SSM
        run: |
          COMMAND_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets "Key=instanceids,Values=${{ secrets.PROD_EC2_INSTANCE_ID }}" \
            --comment "Deploying FastAPI via SSM (Prod)" \
            --parameters 'commands=[
              "set -e",
              "trap \"rm -f /tmp/fastapi-ai/.env\" EXIT",
              "aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin ${{ steps.login-ecr.outputs.registry }}",
              "docker stop fastapi-prod-app || true",
              "docker rm fastapi-prod-app || true",
              "docker image prune -af",
              "docker pull ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:prod-latest",
              "mkdir -p /tmp/fastapi-ai",
              "echo \"AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}\" > /tmp/fastapi-ai/.env",
              "echo \"AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}\" >> /tmp/fastapi-ai/.env",
              "echo \"AWS_REGION=${{ secrets.AWS_REGION }}\" >> /tmp/fastapi-ai/.env",
              "echo \"BEDROCK_REGION=${{ secrets.BEDROCK_REGION }}\" >> /tmp/fastapi-ai/.env",
              "echo \"AWS_BEDROCK_API_KEY=${{ secrets.PROD_AWS_BEDROCK_API_KEY }}\" >> /tmp/fastapi-ai/.env",
              "echo \"BEDROCK_MODEL_ID=${{ secrets.PROD_BEDROCK_MODEL_ID }}\" >> /tmp/fastapi-ai/.env",
              "echo \"BEDROCK_EMBEDDING_MODEL_ID=${{ secrets.PROD_BEDROCK_EMBEDDING_MODEL_ID }}\" >> /tmp/fastapi-ai/.env",
              "echo \"TEMPERATURE=${{ secrets.PROD_TEMPERATURE }}\" >> /tmp/fastapi-ai/.env",
              "echo \"MAX_TOKENS=${{ secrets.PROD_MAX_TOKENS }}\" >> /tmp/fastapi-ai/.env",
              "echo \"TOP_P=${{ secrets.PROD_TOP_P }}\" >> /tmp/fastapi-ai/.env",
              "chmod 600 /tmp/fastapi-ai/.env",
              "docker run -d --name fastapi-prod-app --restart unless-stopped -p 8000:8000 --env-file /tmp/fastapi-ai/.env -v /home/ubuntu/chroma_data:/app/chroma_data ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:prod-latest",
              "echo \"Waiting for application to start...\"",
              "sleep 60",
              "curl -f http://localhost:8000/health || exit 1",
              "echo \"Deployment successful!\""
            ]' \
            --region ${{ env.AWS_REGION }} \
            --query 'Command.CommandId' \
            --output text)

          echo "SSM Command ID: $COMMAND_ID"

          # 최대 10분(600초) 대기, 30초마다 체크
          echo "Waiting for SSM command to complete (max 10 minutes)..."
          for i in {1..20}; do
            sleep 30
            STATUS=$(aws ssm get-command-invocation \
              --command-id $COMMAND_ID \
              --instance-id ${{ secrets.PROD_EC2_INSTANCE_ID }} \
              --query 'Status' \
              --output text 2>/dev/null || echo "Pending")

            echo "[$i/20] Command Status: $STATUS"

            if [ "$STATUS" = "Success" ]; then
              echo "✅ Deployment completed successfully!"
              exit 0
            elif [ "$STATUS" = "Failed" ] || [ "$STATUS" = "Cancelled" ] || [ "$STATUS" = "TimedOut" ]; then
              echo "::error::Deployment failed with status: $STATUS"
              aws ssm get-command-invocation \
                --command-id $COMMAND_ID \
                --instance-id ${{ secrets.PROD_EC2_INSTANCE_ID }} \
                --query 'StandardErrorContent' \
                --output text
              exit 1
            fi
          done

          echo "::error::Deployment timed out after 10 minutes"
          exit 1
